worker_processes auto;

events {
	worker_connections 1024;
}

http {

	log_format json escape=json '{
		"@timestamp": "$time_iso8601", '
		'"remote_addr": "$remote_addr", '
		'"body_bytes_sent": "$body_bytes_sent", '
		'"status": $status, '
		'"request": "$request", '
		'"url": "$uri", '
		'"request_method": "$request_method", '
		'"http_referrer": "$http_referer", '
		'"http_user_agent": "$http_user_agent"
	}';

	access_log /var/log/nginx/access.log json;

	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	upstream reports {
		server unix:/tmp/www.sock;
	}
	upstream reports-slow {
		server unix:/tmp/slow.sock;
	}

	server {
		listen 80;
		listen [::]:80;

#		listen 443 ssl http2;
#		listen [::]:443 ssl http2;

#		ssl_certificate localhost+1.pem;
#		ssl_certificate_key localhost+1-key.pem;

		server_name _;

		root /workspace/htdocs;

		location /reports/fast {
#			alias /workspace/htdocs/fast;

			add_header x-server-engine "php";

			fastcgi_pass	reports;
			fastcgi_param SCRIPT_FILENAME $realpath_root/fast.php;

			fastcgi_intercept_errors on;
			fastcgi_index index.php;

			fastcgi_param  QUERY_STRING	$query_string;
			fastcgi_param  REQUEST_METHOD	$request_method;
			fastcgi_param  CONTENT_TYPE	$content_type;
			fastcgi_param  CONTENT_LENGTH	$content_length;
			fastcgi_param  SCRIPT_NAME	$fastcgi_script_name;
			fastcgi_param  REQUEST_URI	$request_uri;
			fastcgi_param  DOCUMENT_URI	$document_uri;
			fastcgi_param  DOCUMENT_ROOT	$document_root;
			fastcgi_param  SERVER_PROTOCOL	$server_protocol;
			fastcgi_param  REQUEST_SCHEME	$scheme;
			fastcgi_param  HTTPS		$https if_not_empty;
			fastcgi_param  GATEWAY_INTERFACE CGI/1.1;
			fastcgi_param  SERVER_SOFTWARE	nginx/$nginx_version;
			fastcgi_param  REMOTE_ADDR	$remote_addr;
			fastcgi_param  REMOTE_PORT	$remote_port;
			fastcgi_param  SERVER_ADDR	$server_addr;
			fastcgi_param  SERVER_PORT	$server_port;
			fastcgi_param  SERVER_NAME	$server_name;
			fastcgi_param  REDIRECT_STATUS	200;
			fastcgi_param  PATH_INFO	$fastcgi_path_info;

#			fastcgi_read_timeout 60s;

		}

		location /reports/slow {
			add_header x-server-engine "php";

			fastcgi_pass reports-slow;
			fastcgi_param SCRIPT_FILENAME $realpath_root/slow.php;

			fastcgi_intercept_errors on;
			fastcgi_index index.php;

			fastcgi_param  QUERY_STRING	$query_string;
			fastcgi_param  REQUEST_METHOD	$request_method;
			fastcgi_param  CONTENT_TYPE	$content_type;
			fastcgi_param  CONTENT_LENGTH	$content_length;
			fastcgi_param  SCRIPT_NAME	$fastcgi_script_name;
			fastcgi_param  REQUEST_URI	$request_uri;
			fastcgi_param  DOCUMENT_URI	$document_uri;
			fastcgi_param  DOCUMENT_ROOT	$document_root;
			fastcgi_param  SERVER_PROTOCOL	$server_protocol;
			fastcgi_param  REQUEST_SCHEME	$scheme;
			fastcgi_param  HTTPS		$https if_not_empty;
			fastcgi_param  GATEWAY_INTERFACE CGI/1.1;
			fastcgi_param  SERVER_SOFTWARE	nginx/$nginx_version;
			fastcgi_param  REMOTE_ADDR	$remote_addr;
			fastcgi_param  REMOTE_PORT	$remote_port;
			fastcgi_param  SERVER_ADDR	$server_addr;
			fastcgi_param  SERVER_PORT	$server_port;
			fastcgi_param  SERVER_NAME	$server_name;
			fastcgi_param  REDIRECT_STATUS	200;
			fastcgi_param  PATH_INFO	$fastcgi_path_info;

			fastcgi_read_timeout 600s;
		}

		location / {
			try_files $uri $uri/ =404;
		}
	}
}
